@page
@model Backoffice.Razor.Pages.Emprunts.CreateModel
@{
    ViewData["Title"] = "Nouvel emprunt";
}

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-journal-plus"></i> Enregistrer un nouvel emprunt
            </div>
            <div class="card-body">
                <form method="post">
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Utilisateur</label>
                            <div class="position-relative">
                                <input type="text" id="searchUtilisateur" class="form-control" placeholder="Rechercher un utilisateur..." autocomplete="off">
                                <input type="hidden" asp-for="IdUtilisateur" id="hiddenUtilisateur">
                                <div id="listUtilisateur" class="dropdown-menu w-100 shadow" style="max-height: 250px; overflow-y: auto;">
                                    @foreach (var user in Model.Utilisateurs)
                                    {
                                        <a href="#" class="dropdown-item user-item" data-id="@user.IdUtilisateur" data-name="@user.Nom @user.Prenom (@user.NumeroAbonne)" data-search="@user.Nom.ToLower() @user.Prenom.ToLower() @user.Email.ToLower() @user.NumeroAbonne.ToLower()">
                                            <i class="bi bi-person me-2"></i>@user.Nom @user.Prenom <small class="text-muted">(@user.NumeroAbonne)</small>
                                        </a>
                                    }
                                </div>
                            </div>
                            <span asp-validation-for="IdUtilisateur" class="text-danger"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Livre</label>
                            <div class="position-relative">
                                <input type="text" id="searchLivre" class="form-control" placeholder="Rechercher un livre..." autocomplete="off">
                                <input type="hidden" asp-for="IdLivre" id="hiddenLivre">
                                <div id="listLivre" class="dropdown-menu w-100 shadow" style="max-height: 250px; overflow-y: auto;">
                                    @foreach (var livre in Model.Livres)
                                    {
                                        var badgeClass = livre.StockDisponible >= 3 ? "bg-success" : "bg-warning text-dark";
                                        <a href="#" class="dropdown-item livre-item" data-id="@livre.IdLivre" data-name="@livre.Titre" data-search="@livre.Titre.ToLower() @livre.ISBN?.ToLower()" data-stock="@livre.StockDisponible">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span><i class="bi bi-book me-2"></i>@livre.Titre</span>
                                                <span class="badge @badgeClass">@livre.StockDisponible</span>
                                            </div>
                                        </a>
                                    }
                                </div>
                            </div>
                            <span asp-validation-for="IdLivre" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Date d'emprunt</label>
                            <input asp-for="DateEmprunt" type="date" class="form-control" required>
                            <span asp-validation-for="DateEmprunt" class="text-danger"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Date de retour prévue</label>
                            <input asp-for="DateRetourPrevue" type="date" class="form-control" required>
                            <span asp-validation-for="DateRetourPrevue" class="text-danger"></span>
                            <small class="text-muted">Durée maximale : 21 jours</small>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Règles d'emprunt :</strong>
                        <ul class="mb-0 mt-2">
                            <li>Maximum 3 emprunts simultanés par utilisateur</li>
                            <li>Durée maximale : 21 jours</li>
                            <li>2 prolongations possibles de 7 jours chacune</li>
                        </ul>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg"></i> Enregistrer l'emprunt
                        </button>
                        <a href="/Emprunts/Index" class="btn btn-outline-secondary">Annuler</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const dateEmprunt = document.getElementById('DateEmprunt');
            const dateRetour = document.getElementById('DateRetourPrevue');

            // Définir la date d'emprunt à aujourd'hui
            const today = new Date().toISOString().split('T')[0];
            dateEmprunt.value = today;

            // Définir la date de retour à 21 jours
            const retourDate = new Date();
            retourDate.setDate(retourDate.getDate() + 21);
            dateRetour.value = retourDate.toISOString().split('T')[0];

            // Mettre à jour la date de retour quand la date d'emprunt change
            dateEmprunt.addEventListener('change', function() {
                const emprunt = new Date(this.value);
                emprunt.setDate(emprunt.getDate() + 21);
                dateRetour.value = emprunt.toISOString().split('T')[0];
            });

            // Autocomplétion pour utilisateurs
            const searchUtilisateur = document.getElementById('searchUtilisateur');
            const listUtilisateur = document.getElementById('listUtilisateur');
            const hiddenUtilisateur = document.getElementById('hiddenUtilisateur');
            const userItems = listUtilisateur.querySelectorAll('.user-item');

            searchUtilisateur.addEventListener('focus', function() {
                listUtilisateur.classList.add('show');
            });

            searchUtilisateur.addEventListener('input', function() {
                const search = this.value.toLowerCase();
                listUtilisateur.classList.add('show');
                userItems.forEach(item => {
                    if (item.dataset.search.includes(search)) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });

            userItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    hiddenUtilisateur.value = this.dataset.id;
                    searchUtilisateur.value = this.dataset.name;
                    searchUtilisateur.classList.add('is-valid');
                    listUtilisateur.classList.remove('show');
                });
            });

            // Autocomplétion pour livres
            const searchLivre = document.getElementById('searchLivre');
            const listLivre = document.getElementById('listLivre');
            const hiddenLivre = document.getElementById('hiddenLivre');
            const livreItems = listLivre.querySelectorAll('.livre-item');

            searchLivre.addEventListener('focus', function() {
                listLivre.classList.add('show');
            });

            searchLivre.addEventListener('input', function() {
                const search = this.value.toLowerCase();
                listLivre.classList.add('show');
                livreItems.forEach(item => {
                    if (item.dataset.search.includes(search)) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });

            livreItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    hiddenLivre.value = this.dataset.id;
                    searchLivre.value = this.dataset.name;
                    searchLivre.classList.add('is-valid');
                    listLivre.classList.remove('show');
                });
            });

            // Fermer les listes au clic extérieur
            document.addEventListener('click', function(e) {
                if (!searchUtilisateur.contains(e.target) && !listUtilisateur.contains(e.target)) {
                    listUtilisateur.classList.remove('show');
                }
                if (!searchLivre.contains(e.target) && !listLivre.contains(e.target)) {
                    listLivre.classList.remove('show');
                }
            });
        });
    </script>
}
