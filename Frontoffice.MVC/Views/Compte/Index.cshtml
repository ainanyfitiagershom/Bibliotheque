@model CompteIndexViewModel
@{
    ViewData["Title"] = "Mon espace";
}

<div class="container py-5">
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                        <span class="text-white fw-bold" style="font-size: 2rem;">@Model.Utilisateur.Nom[0]@Model.Utilisateur.Prenom[0]</span>
                    </div>
                    <h4>@Model.Utilisateur.Prenom @Model.Utilisateur.Nom</h4>
                    <p class="text-muted">@Model.Utilisateur.Email</p>
                    <span class="badge bg-secondary">@Model.Utilisateur.NumeroAbonne</span>
                </div>
                <div class="list-group list-group-flush">
                    <a asp-action="Profil" class="list-group-item list-group-item-action">
                        <i class="bi bi-person"></i> Mon profil
                    </a>
                    <a asp-controller="Emprunts" asp-action="Index" class="list-group-item list-group-item-action">
                        <i class="bi bi-book"></i> Mes emprunts
                    </a>
                    <a asp-controller="Reservations" asp-action="Index" class="list-group-item list-group-item-action">
                        <i class="bi bi-bookmark"></i> Mes réservations
                    </a>
                    <a asp-action="Historique" class="list-group-item list-group-item-action">
                        <i class="bi bi-clock-history"></i> Historique
                    </a>
                    <a asp-action="Notifications" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-bell"></i> Notifications</span>
                        @if (Model.NombreNotificationsNonLues > 0)
                        {
                            <span class="badge bg-danger">@Model.NombreNotificationsNonLues</span>
                        }
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <!-- Emprunts en cours -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-book"></i> Emprunts en cours (@Model.EmpruntsEnCours.Count)</span>
                    <a asp-controller="Emprunts" asp-action="Index" class="btn btn-sm btn-outline-primary">Voir tout</a>
                </div>
                <div class="card-body">
                    @if (Model.EmpruntsEnCours.Any())
                    {
                        @foreach (var emprunt in Model.EmpruntsEnCours.Take(3))
                        {
                            <div class="d-flex align-items-center mb-3 pb-3 border-bottom">
                                @if (!string.IsNullOrEmpty(emprunt.ImageCouverture))
                                {
                                    <img src="@emprunt.ImageCouverture" alt="Couverture" class="me-3" style="width: 50px; height: 70px; object-fit: cover;">
                                }
                                else
                                {
                                    <div class="bg-secondary me-3 d-flex align-items-center justify-content-center" style="width: 50px; height: 70px;">
                                        <i class="bi bi-book text-white"></i>
                                    </div>
                                }
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">
                                        <a href="/Livres/Details/@emprunt.IdLivre" class="text-decoration-none">@emprunt.TitreLivre</a>
                                    </h6>
                                    <small class="text-muted">@emprunt.NomAuteur</small>
                                    <div>
                                        @{
                                            var joursRestants = (emprunt.DateRetourPrevue - DateTime.Today).Days;
                                            var badgeClass = joursRestants < 0 ? "bg-danger" : joursRestants <= 3 ? "bg-warning text-dark" : "bg-success";
                                        }
                                        <span class="badge @badgeClass">
                                            @if (joursRestants < 0)
                                            {
                                                <span>En retard de @Math.Abs(joursRestants) jour(s)</span>
                                            }
                                            else if (joursRestants == 0)
                                            {
                                                <span>Retour aujourd'hui</span>
                                            }
                                            else
                                            {
                                                <span>@joursRestants jour(s) restant(s)</span>
                                            }
                                        </span>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-muted text-center mb-0">Aucun emprunt en cours.</p>
                    }
                </div>
            </div>

            <!-- Réservations -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-bookmark"></i> Réservations (@Model.Reservations.Count)</span>
                    <a asp-controller="Reservations" asp-action="Index" class="btn btn-sm btn-outline-primary">Voir tout</a>
                </div>
                <div class="card-body">
                    @if (Model.Reservations.Any())
                    {
                        @foreach (var reservation in Model.Reservations.Take(3))
                        {
                            <div class="d-flex align-items-center mb-3 pb-3 border-bottom">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">
                                        <a href="/Livres/Details/@reservation.IdLivre" class="text-decoration-none">@reservation.TitreLivre</a>
                                    </h6>
                                    <small class="text-muted">@reservation.NomAuteur</small>
                                    <div>
                                        @if (reservation.Statut == "Disponible")
                                        {
                                            <span class="badge bg-success">Disponible - À récupérer</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-info">Position @reservation.PositionFile dans la file</span>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-muted text-center mb-0">Aucune réservation.</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>
